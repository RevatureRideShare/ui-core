#!groovy

properties(
    [
        [$class: 'BuildDiscarderProperty', strategy:
          [$class: 'LogRotator', artifactDaysToKeepStr: '14', artifactNumToKeepStr: '5', daysToKeepStr: '30', numToKeepStr: '60']],
        pipelineTriggers(
          [
              pollSCM('H/15 * * * *'),
              cron('@daily'),
          ]
        )
    ]
)
node {
  stage('Checkout') {
    //disable to recycle workspace data to save time/bandwidth
    deleteDir()
    checkout scm
    sh 'echo $BRANCH_NAME'
    //enable for commit id in build number
    //env.git_commit_id = sh returnStdout: true, script: 'git rev-parse HEAD'
    //env.git_commit_id_short = env.git_commit_id.take(7)
    //currentBuild.displayName = "#${currentBuild.number}-${env.git_commit_id_short}"
  }
  stage('NPM Install') {
      withEnv(["NPM_CONFIG_LOGLEVEL=warn"]) {
       sh 'pwd'
       sh 'which nvm'
       sh 'npm i'
      }
    }
    stage('Build') {
      milestone()
      sh 'cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency'
      sh '. ~/.nvm/nvm.sh'
      sh 'ng build'
    }
    stage('Test') {
      withEnv(["CHROME_BIN=/usr/bin/chromium"]) {
        sh 'cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency'
        sh '. ~/.nvm/nvm.sh'
        sh 'npm run test-headless'
      }
    }
    stage('Lint') {
      sh 'cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency'
      sh '. ~/.nvm/nvm.sh'
      sh 'ng lint'
    }
  if(env.BRANCH_NAME == 'master'){
    stage('Deploy'){
      steps{
      sh '''
      cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency
      aws2 s3 cp --recursive ./dist s3://ui-core/RideShare
      '''
      }
    }
  }
  else {
  println "Current branch ${env.BRANCH_NAME}"
  }
}
