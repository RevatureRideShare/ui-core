#!groovy

pipeline {
    agent any
    triggers {
        pollSCM('H H/8 * * *')
    }    
    options { 
        disableConcurrentBuilds()
    }
    stages {
        stage('Install') {
            steps {
                echo 'Delete dir'
                sh 'pwd'
                sh '''
                    . ~/.nvm/nvm.sh
                    ls -alh
                    cd RideShare
		            npm install
                '''
            }
         }

         stage('Install Scanner'){
             steps{
                 sh '''
                export SONAR_SCANNER_VERSION=4.2.0.1873
                export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
                rm -rf $SONAR_SCANNER_HOME
                mkdir -p $SONAR_SCANNER_HOME
                curl -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
                unzip $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
                rm $HOME/.sonar/sonar-scanner.zip
                export PATH=$SONAR_SCANNER_HOME/bin:$PATH
                export SONAR_SCANNER_OPTS="-server"
                sonar-scanner \
                -Dsonar.projectKey=RevatureRideShare_ui-core \
                -Dsonar.organization=b44ffadc-08d5-11ea-8d71-362b9e155667 \
                -Dsonar.sources=. \
                -Dsonar.host.url=https://sonarcloud.io/ \
                -Dsonar.login=f13453caf6dccc2ca1b0957363483278a174f20b
                 '''
             }
         }
        // stage('Karma Test') {
        //       steps {
        //         sh '''
        //             . ~/.nvm/nvm.sh
        //             cd RideShare
        //             npm run test-headless
        //         '''
        //     }
        // }
        // stage('Build') {
        //       steps {
        //         sh '''
        //             . ~/.nvm/nvm.sh 
        //             cd RideShare                   
		//             ng build
        //         '''
        //     }
        // }
        // stage('Deploy') {
        //       steps {
        //         script{
        //           if(env.BRANCH_NAME == 'chore/master'){
        //             sh '''
        //                 cd RideShare
        //                 aws s3 cp --recursive ./dist/Project3 s3://rideshare-client
        //             '''
        //           }
        //         }
        //     }
        // }
    }
    post{
        failure{
            echo 'Deleting from workspace: ' + env.BRANCH_NAME
            sh 'pwd'
        }
    }
}