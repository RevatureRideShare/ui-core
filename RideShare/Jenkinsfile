#!groovy

properties(
    [
        [$class: 'BuildDiscarderProperty', strategy:
          [$class: 'LogRotator', artifactDaysToKeepStr: '14', artifactNumToKeepStr: '5', daysToKeepStr: '14', numToKeepStr: '60']],
        pipelineTriggers(
          [
              pollSCM('H H(8-23)/6 * * 1-5'),
              cron('@daily'),
          ]
        )
    ]
)
node {
    stage('Checkout') {
        //disable to recycle workspace data to save time/bandwidth
        deleteDir()
        checkout scm

        //enable for commit id in build number
        //env.git_commit_id = sh returnStdout: true, script: 'git rev-parse HEAD'
        //env.git_commit_id_short = env.git_commit_id.take(7)
        //currentBuild.displayName = "#${currentBuild.number}-${env.git_commit_id_short}"
    }

    stage('NPM Install') {
            sh '''
                cd /var/jenkins_home/workspace/ui-core/RideShare
                curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
                npm config delete prefix 
                npm config set prefix $NVM_DIR/versions/node/v13.1.0
                . ~/.nvm/nvm.sh
		        nvm install node						
                npm install
            '''
        
    }

    // stage('basic node install'){
    //     sh 'curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash'
    //     sh '. ~/.nvm/nvm.sh'
    //     sh 'nvm install node'
    // }

    //     stage('EC2 Setup'){
    //             sh 'cd ~'
    //             sh 'ls -alh'
    //             sh 'env'                
    //             sh 'curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash'
    //             sh 'chmod +777 ~/.nvm/nvm.sh'
    //             sh 'export NVM_DIR="$HOME/.nvm"'
    //             sh '~/.nvm/nvm.sh'
    //             sh 'cd ~'
    //             sh 'sleep 2'
    //             sh 'pwd'
    //             sh 'nvm install node' 
    //             sh '''
    //                 wget https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm
    //                 sudo yum install ./google-chrome-stable_current_x86_64.rpm
    //                 sudo ln -s /usr/bin/google-chrome-stable /usr/bin/chromium
    //             '''
            
    //    }
        stage('NPM Install') {
        withEnv(["NPM_CONFIG_LOGLEVEL=warn"]) {
            sh '''
                cd /var/jenkins_home/workspace/ui-core/RideShare						
                npm install
            '''
            }
        }

        stage('Test') {
            withEnv(["CHROME_BIN=/usr/bin/chromium"]) {
            sh '''
                    cd /var/jenkins_home/workspace/ui-core/RideShare
                    npm run test-headless
                '''
            }
            junit '**/test-results.xml'
        }
        // stage('Build') { 
        //   steps {
        //         sh '''
        //         cd /jenkins_home/.jenkins/workspace/ui-core/RideShare
        //         ng build
        //         '''
        //   }
        // }
        // stage('Deploy'){
        //     steps{
        //         sh '''
        //         cd /jenkins_home/.jenkins/workspace/ui-core/RideShare
        //          aws2 s3 cp --recursive ./dist s3://ui-core/angular
        //         '''
        //     }
        // }
    
}