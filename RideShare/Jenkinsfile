#!groovy

pipeline {
    agent any
    triggers {
        pollSCM('H H/8 * * *')
    }    
    options { 
        disableConcurrentBuilds()
    }
    stages {
        stage('Install') {
            steps {
                sh '''
                    . ~/.nvm/nvm.sh
                    ls -alh
                    cd RideShare
		            npm install
                '''
            }
         }
         
        stage('test') {
              steps {
                sh '''
                    . ~/.nvm/nvm.sh
                    cd RideShare
                    npm run test-headless
                '''
            }
        }
        
        stage('Build') {
              steps {
                
                sh '''
                    . ~/.nvm/nvm.sh 
                    cd RideShare                   
		            ng build
                '''
            }
        }
        
        stage('Deploy') {
              steps {
                script{
                  if(env.BRANCH_NAME == 'chore/master'){
                    sh '''
                        cd RideShare
                        aws s3 cp --recursive ./dist/Project3 s3://rideshare-client
                    '''
                  }
                }
            }
        }
    }
    post{
        failure{
            echo 'Deleting from workspace: ' + env.BRANCH_NAME
            sh 'pwd'
        }
    }
}