#!groovy

properties(
    [
        [$class: 'BuildDiscarderProperty', strategy:
          [$class: 'LogRotator', artifactDaysToKeepStr: '14', artifactNumToKeepStr: '5', daysToKeepStr: '30', numToKeepStr: '60']],
        pipelineTriggers(
          [
              pollSCM('H/15 * * * *'),
              cron('@daily'),
          ]
        )
    ]
)
node {
  if(env.BRANCH_NAME == 'master'){
    stage('NPM Install') {
        sh 'cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency'
        sh 'npm install'
    }
    stage('Build') {
      milestone()
      sh '''
      cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency \
      ng build --prod --aot --sm --progress=false
      ''' 
    }
    stage('Test') {
      withEnv(["CHROME_BIN=/usr/bin/chromium"]) {
        sh '''
        cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency
        npm run test-headless
        '''
      }
    }
    stage('Lint') {
      sh '''
        cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency
        ng lint
        '''
    }
    stage('Archive') {
      sh 'tar -cvzf dist.tar.gz --strip-components=1 dist'
      archive 'dist.tar.gz'
    }
    stage('Deploy'){
      steps{
      sh '''
      cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency
      aws2 s3 cp --recursive ./dist s3://ui-core/RideShare
      '''
      }
   }
  }
else {
  println "Current branch ${env.BRANCH_NAME}"
  stage('NPM Install') {
      withEnv(["NPM_CONFIG_LOGLEVEL=warn"]) {
        sh 'cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency'
        sh 'npm install'
      }
    }
    stage('Build') {
      sh '''
      cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency \
      ng build --prod --aot --sm --progress=false
      ''' 
    }
    stage('Test') {
      withEnv(["CHROME_BIN=/usr/bin/chromium"]) {
        sh '''
        cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency
        npm run test-headless
        '''
      }
    }
    stage('Lint') {
      sh '''
        cd /home/ec2-user/.jenkins/workspace/ore_chore_1-PhantomJS-dependency
        ng lint
        '''
    }
  }
}
